<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Lightbox</title>
	<link rel="stylesheet" href="./src/style/screen.template.css">
	<link rel="stylesheet" href="./src/fontawesome/css/all.css">
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"
		integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
	<script src="./script.js"></script>
</head>

<body>
	<div class="saRootContentWrapper">
		<div class="saSideBar saSideBarJs saExpanded">
			<nav id="SideBar">
				<div class="saSidenav">
					<div class="saSidenavSection">
						<div class="saCustomerLogo">
							<div>
								<img src="./src/img/logo.svg" style="height: 80px;">
							</div>
						</div>
						<div class="saSidenavContainer">
							<div>
								<a class="saSidenavItemWrapper saSearch saHideWhenExpanded" tabindex="0">
									<div class="saSidenavItem">
										<i class="far fa-magnifying-glass saIcon"></i>
									</div>
								</a>
								<div class="saSidenavItemWrapper saSearch saHideWhenMinimized">
									<div class="saSidenavItem saInputTextWrapper">
										<input id="MenuEnterpriseSearchBox" class="saSearchInput saInputText"
											type="search" placeholder="Sök...">
										<i class="far fa-magnifying-glass saIcon"></i>
									</div>
								</div>
							</div>
							<div class="saSidenavItem saMenuDropdownsOuter">
								<div class="saSidenavItemWrapper">
									<label class="saInputTextWrapper saLabeled">
										<span class="saLabeledLabel">User</span>
										<span class="saFirstLetter">J</span>
										<select class="saInputText saDropdown">
											<option value="1" selected="true">Jonathan</option>
											<option value="2">Ellioth</option>
											<option value="2">Pontus</option>
										</select>
										<div class="saTrailingIconsWrapper">
											<i class="saIcon far fa-angle-down"></i>
										</div>
									</label>
								</div>
							</div>
							<div class="saToggleWrapper">
								<div class="saHandle">
									<div class="saTrack">
										<a class="saToggleIconText saDynamicTooltipJs saActive" tabindex="0"
											data-sa-menutabid="1">
											<i class="far fa-bars icon saIcon"></i>
											<span class="saToggleText">Meny</span>
										</a>
										<a class="saToggleIconText saDynamicTooltipJs" tabindex="0">
											<i class="far fa-star icon saIcon"></i>
											<span class="saToggleText">Favoriter</span>
										</a>
									</div>
								</div>
							</div>
						</div>
						<div class="saSidenavLists">
							<ul class="saSidenavItemList">
								<li>
									<a class="saSidenavItemWrapper" tabindex="0">
										<div class="saSidenavItem">
											<i class="far fa-house-window icon saIcon"></i>
											<span class="saSidenavItemText">Home</span>
										</div>
									</a>
								</li>
							</ul>
						</div>
					</div>
					<div class="saSidenavSection saSidenavSectionLast">
						<div class="saSidenavContainer">
							<div class="saListItem">
								<button class="saSidenavItemWrapper" aria-expanded="false">
									<div class="saSidenavItem saAvatarWrapperOuter">
										<img src="./src/img/avatar2.png" class="saAvatarWrapper">
										<span class="saSidenavItemText">Jonathan Kevin</span>
										<i class="far fa-angle-down saIcon"></i>
									</div>
								</button>
							</div>
							<div class="saSidenavItem saSidenavItemRow">
								<button class="saSidenavItemWrapper">
									<div class="saSidenavItem">
										<i class="fa-window-restore far icon saIcon"></i>
									</div>
								</button>
								<button class="saSidenavItemWrapper">
									<div class="saSidenavItem">
										<i class="fa-cog far icon saIcon"></i>
									</div>
								</button>
								<button class="saSidenavItemWrapper">
									<div class="saSidenavItem">
										<i class="fa-sun-alt far icon saIcon"></i>
									</div>
								</button>
								<button class="saSidenavItemWrapper saNotificationLinkLargeScreen"
									aria-label="2 Notifieringar" aria-live="polite" data-tooltip="Notifieringar">
									<div class="saSidenavItem">
										<div>
											<i class="far fa-bell saIcon"></i>
										</div>
										<span class="saSidenavItemText">Notifieringar</span>
									</div>
									<div class="saNotificationBadge">
										<div class="saNotificationBadgeCount">2</div>
									</div>
								</button>
							</div>
						</div>
						<div class="saSidenavFooter">
							<a class="saSoftadminLogo" target="_blank" rel="noopener noreferrer" tabindex="-1"
								href="https://www.multisoft.se/softadmin/">
								<span class="saLogo"></span>
								<span class="saWordmark">
									<div class="saSweep">
										<div class="saSweepText">
											<span>SOFTADMIN</span> <span class="saSweepR">®</span>
											<span class="saSweep8">8</span>
										</div>
										<div class="saSweepEffect">
											<div> <span>SOFTADMIN</span> <span class="saSweepR">®</span> <span
													class="saSweep8">8</span> </div>
											<div> <span>SOFTADMIN</span> <span class="saSweepR">®</span> <span
													class="saSweep8">8</span> </div>
											<div> <span>SOFTADMIN</span> <span class="saSweepR">®</span> <span
													class="saSweep8">8</span> </div>
										</div>
									</div>
								</span>
							</a>
							<button class="saExpander saDynamicTooltipJs">
								<i class="fa-angles-left far saIcon"></i>
							</button>
						</div>
					</div>
				</div>
			</nav>
		</div>
		<div class="saRightFrameRoot">
			<div class="right standardview saLargeScreen saPc saCompact saHasTopButtons">
				<form class="interface">
					<header id="pageheader" class="saPageHeaderHolder">
						<div class="saDesktopHeader saPageHeader">
							<div class="saHeader">
								<div class="saRowWrapper">
									<div class="saTopRow">
										<nav class="saBreadcrumbs" aria-label="Brödsmulor">
											<div class="saBackButtonWrapper">
												<button class="saBackButton"><i
														class="fa-arrow-left far saBack saIcon"></i></button>
											</div>
											<span class="saBreadcrumb">
												<a tabindex="0">
													First link
												</a>
											</span>
											<span class="saBreadcrumbSeparator">&gt;</span>
											<span class="saBreadcrumb">
												<a tabindex="0">
													Second link
												</a>
											</span>
										</nav>
									</div>
									<div class="saBottomRow">
										<div class="saTitle">
											<h1 class="saHeaderText">
												Title
											</h1>
										</div>
									</div>
									<nav class="saNavigationBar">
										<div class="saTopButtons">
											<div class="saActionLinks">
												<button class="saTopLink saActionLink saButtonPrimary">
													<div class="saIconHolder">
														<i class="far fa-crow saIcon"></i>
													</div>
													<span class="saButtonText">Crow button</span>
												</button>
												<button class="saTopLink saActionLink saButtonSecondary">
													<div class="saIconHolder">
														<i class="far fa-egg saIcon"></i>
													</div>
													<span class="saButtonText">Egg button</span>
												</button>
												<div class="saCollectorWrapper">
													<button class="saMoreButton">
														<i class="far fa-ellipsis-vertical icon saIcon"></i>
													</button>
												</div>
											</div>
										</div>
									</nav>
								</div>
							</div>
						</div>
						<div class="saPageHeader saSmallScreenHeader">
							<div class="saHeader">
								<div class="saHeaderInner">
									<div class="saTopRow">
										<button class="saBackButton" data-tooltip="Stäng: Visa underhållspunkt"
											aria-label="Stäng: Visa underhållspunkt"><i
												class="fa-arrow-left far saBack saIcon"></i>
										</button>
										<div class="saHeaderWrapper">
											<div class="saTitle">
												<h1 class="saHeaderText">Title</h1>
											</div>
										</div>
										<button class="saNavigator">
											<div class="saNavBar">
												<span class="saNavBarStripe"></span>
												<span class="saNavBarStripe"></span>
												<span class="saNavBarStripe"></span>
											</div>
										</button>
										<button class="saNotificationWrapper">
											<div><i class="far fa-bell saIcon"></i></div>
											<div class="saNotificationBadge">
												<div class="saNotificationBadgeCount">2</div>
											</div>
										</button>
									</div>
								</div>
								<nav class="saBottomRow saActionLinkBar">
									<div class="saTopButtons saActionLinks">
										<button class="saTopLink saActionLink saButtonPrimary">
											<div class="saIconHolder">
												<i class="far fa-crow saIcon"></i>
											</div>
											<span class="saButtonText">Crow button</span>
										</button>
										<button class="saTopLink saActionLink saButtonSecondary">
											<div class="saIconHolder">
												<i class="far fa-egg saIcon"></i>
											</div>
											<span class="saButtonText">Egg button</span>
										</button>
										<div class="saCollectorWrapper">
											<button class="saMoreButton">
												<i class="far fa-ellipsis-vertical icon saIcon"></i>
											</button>
										</div>
									</div>
								</nav>
							</div>
						</div>
					</header>

					<div class="maincolinner gradients">
						<main class="menuitem pagecontentframe">
							<div class="scrollindicator" style="display: none;" hidden></div>
							<div class="scrollcontent saScrollable">
								<div class="scrollcontent-inner">
									<div class="saLightboxGroup">
										<lightbox-image data-dialog-id="lightbox">
											<img crossorigin="anonymous" loading="lazy"
												src='https://images.unsplash.com/photo-1444464666168-49d633b86797?q=80&w=2069&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'
												alt='Bird'>
										</lightbox-image>

										<lightbox-image data-dialog-id="lightbox">
											<img crossorigin="anonymous" loading="lazy"
												src='https://images.unsplash.com/photo-1491485880348-85d48a9e5312?q=80&w=2670&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'
												alt='Cat'>
										</lightbox-image>

										<lightbox-image data-dialog-id="lightbox">
											<img crossorigin="anonymous" loading="lazy" src='./src/img/pretty.png'
												alt='A very pretty dog'>
										</lightbox-image>

										<lightbox-image data-dialog-id="lightbox">
											<img crossorigin="anonymous" loading="lazy" src='./src/img/the-cat.png'
												alt='A very pretty cat'>
										</lightbox-image>
									</div>

									<dialog id="lightbox" class="saLightboxOverlay">
										<form method="dialog">
											<button autofocus class="saDialogButtonClose saDestructive" aria-label="Close lightbox" data-tooltip="Close">
												<i class="saIcon far fa-xmark"></i>
											</button>
											<div class="saLightbox">

											</div>
										</form>
									</dialog>
								</div>
							</div>
						</main>
					</div>
				</form>
			</div>
		</div>
	</div>
	<script>

		$(document).ready(function () {
			class LightboxImage extends HTMLElement {
				get dialog() {
					const attr = this.getAttribute("data-dialog-id");
					return document.getElementById(attr);
				}

				constructor() {
					super();
					this.attachShadow({ mode: "open" });
				}

				connectedCallback() {
					this.image = this.querySelector("img");
					this.imageWrapper = this.querySelector(".saLightbox");
					this.shadowRoot.innerHTML = this.addButton();
					this.toggle = this.shadowRoot.querySelector("button");
					this.toggle.addEventListener("click", this);
					this.dialog.addEventListener("click", this);
					this.dialog.addEventListener("cancel", this);

					this.dialog.querySelector(".saLightbox").addEventListener('touchstart', this);
					this.dialog.querySelector(".saLightbox").addEventListener('touchmove', this);
					this.dialog.querySelector(".saLightbox").addEventListener('touchend', this);

					// Add event listener for close button
					const closeButton = this.dialog.querySelector('.saDialogButtonClose');
					if (closeButton) {
						closeButton.addEventListener("click", this);
					}
				}

				ontouchstart(e) {
					this.startY = e.touches[0].clientY;
					this.startX = e.touches[0].clientX;
				}

				ontouchmove(e) {
					if (e.touches.length > 1) return; // Skip multi-touch

					this.currentY = e.touches[0].clientY;
					this.currentX = e.touches[0].clientX;
					this.translateY = this.currentY - this.startY;
					this.translateX = this.currentX - this.startX;

					if (!this.rafPending) {
						this.rafPending = true;
						requestAnimationFrame(() => {
							this.dialog.querySelector(".saLightbox").style.transform = `translate(${this.translateX}px, ${this.translateY}px)`;
							this.dialog.style.setProperty('--backdrop', Math.max(0, 0.8 - Math.abs(this.translateY) / 400));
							this.rafPending = false;
						});
					}
				}

				ontouchend(e) {
					const threshold = 80;

					if (Math.abs(this.translateY) > threshold) {
						document.startViewTransition(() => this.moveImageBack());
						this.dialog.querySelector(".saLightbox").style.transform = "";

					} else {
						this.dialog.querySelector(".saLightbox").style.transform = "translate(0, 0)";
					}
				}


				addButton() {
					return `
                <style>
                    button {
                        all: unset;
                        outline: revert;
                        display: grid;
                        grid-template-areas: "box";
                    }

                    button > * {
                        grid-area: box;
                    }

                    img {
                        max-width: 100%;
                        height: auto;
                        visibility: hidden;
                    }
                </style>

                <button aria-label="Open image in lightbox" type="button" aria-expanded="false">
                    ${this.image.outerHTML}
                    <div>
                        <slot></slot>
                    </div>
                </button>
            	`;
				}

				handleEvent(e) {
					this[`on${e.type}`](e);
				}

				onclick(e) {
					if (e.currentTarget === this.toggle) {
						this.moveImage(() => this.moveImageToTarget());
						this.setDynamicBackgroundColor(this.image);
						this.zoomEnabled(this.image);
					}

					if (e.currentTarget === this.dialog) {
						this.dialogCallback(e);
					}
				}

				// Handle "escape" key dialog event
				oncancel(e) {
					this.dialogCallback(e);
				}

				dialogCallback(e) {
					// If the image is in the dialog and click was outside the image or on close button
					if (this.dialog.contains(this.image)) {
						// Check if click was on the background (dialog itself) or close button
						if (e.target === this.dialog || e.target.closest('.saDialogButtonClose')) {
							e.preventDefault();
							this.moveImage(() => this.moveImageBack());
						}
					}
				}

				moveImage(fn) {
					if (!document.startViewTransition) {
						fn();
					} else {
						this.handleViewTransition(fn);
					}
				}

				async handleViewTransition(fn) {
					this.image.style.viewTransitionName = "lightbox-image-active";

					const transition = document.startViewTransition(() => fn());

					try {
						await transition.finished;
					} finally {
						this.image.style.removeProperty("view-transition-name");
					}
				}

				moveImageToTarget() {
					if (document.body.classList.contains('saPc')) {
						// Create a button and wrap the image inside it
						const zoomButton = document.createElement("button");
						zoomButton.type = "button";
						zoomButton.ariaLabel = "Zoom in on this image";
						zoomButton.classList.add("saZoomButton");
						zoomButton.append(this.image);
						this.dialog.querySelector(".saLightbox").append(zoomButton);

						// Add event listener for toggling zoom
						zoomButton.addEventListener("click", () => this.toggleZoom());
					} else {
						this.dialog.querySelector(".saLightbox").append(this.image);
					}
					this.dialog.showModal();
				}

				moveImageBack() {
					this.append(this.image);
					this.dialog.close();
					this.dialog.classList.remove('saZoomFull');
					this.dialog.classList.remove('saLarger');
					this.image.style.backgroundColor = '';
					this.dialog.style.transform = '';
				}


				setDynamicBackgroundColor(img) {
					if (!img.complete) return;

					try {
						const avgColor = this.getAverageColor(img); // Add 'this.'
						const luminance = this.calculateLuminance(avgColor); // Add 'this.'
						const backgroundColor = luminance < 128 ? 'white' : 'black';
						img.style.backgroundColor = backgroundColor;
					} catch (error) {
						// Fallback if getImageData fails due to CORS
						console.warn("Could not analyze image colors - CORS issue:", error);
						img.style.backgroundColor = 'black'; // Fallback to black
					}
				}


				getAverageColor(imgElement) {
					const canvas = document.createElement('canvas');
					const context = canvas.getContext('2d');
					canvas.width = imgElement.naturalWidth;
					canvas.height = imgElement.naturalHeight;
					context.drawImage(imgElement, 0, 0, canvas.width, canvas.height);
					const data = context.getImageData(0, 0, canvas.width, canvas.height).data;

					let r = 0, g = 0, b = 0, count = 0;
					for (let i = 0; i < data.length; i += 4) {
						if (data[i + 3] > 0) {
							r += data[i];
							g += data[i + 1];
							b += data[i + 2];
							count++;
						}
					}
					return { r: Math.floor(r / count), g: Math.floor(g / count), b: Math.floor(b / count) };
				}

				calculateLuminance(color) {
					return 0.299 * color.r + 0.587 * color.g + 0.114 * color.b;
				}

				zoomEnabled(img) {
					if (img.naturalWidth >= window.innerWidth ||
						img.naturalHeight >= window.innerHeight) {
						this.dialog.classList.add('saLarger');
					} else {
						this.dialog.classList.remove('saLarger');
					}
				}

				toggleZoom() {
					if (this.dialog.classList.contains('saZoomFull')) {
						this.dialog.classList.remove('saZoomFull');
					} else {
						this.dialog.classList.add('saZoomFull');
					}
				}
			}

			customElements.define("lightbox-image", LightboxImage);
		});

	</script>
</body>

</html>