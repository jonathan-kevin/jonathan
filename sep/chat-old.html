<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Jonathan</title>
	<link rel="stylesheet" href="./src/style/screen.template.css">
	<link rel="stylesheet" href="../src/fontawesome/css/all.css">
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"
		integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
	<script src="./script.js"></script>
	<script type="text/javascript" src="https://livejs.com/live.js"></script>
	<link rel="icon" type="image/png" size="16x16" href="../src/img/favicon.svg">
</head>

<body class="saRootBody saLargeScreen saPc saCompact">
	<div class="saRootContentWrapper">
		<div class="saSideBar saSideBarJs saExpanded">
			<form id="aspnetForm">
				<nav id="SideBar">
					<div class="saPageHeader saSmallScreenHeader">
						<div class="saHeader">
							<div class="saTopRow">
								<button class="saNavigator" type="button">
									<div class="saNavBar saActive"><span class="saNavBarStripe"></span>
										<span class="saNavBarStripe"></span>
										<span class="saNavBarStripe"></span>
									</div>
								</button>
								<div class="saHeaderWrapper">
									<div class="saTitle">
										<h1>Softadmin® Utvecklingssystem</h1>
									</div>
								</div>
								<button class="saNotificationWrapper" type="button">
									<div><i class="far fa-bell saIcon"></i></div>
									<div class="saNotificationBadge saEmpty" aria-hidden="true">
										<div class="saNotificationBadgeCount">0</div>
									</div>
								</button>
							</div>
						</div>
					</div>
					<div class="saSidenav" id="sidenav">
						<div class="saSidenavSection">
							<div class="saCustomerLogo">
								<div>
									<img loading="lazy" src="../src/img/logo.svg" alt="Softadmin® logo"
										style="min-height: 5rem;">
								</div>
							</div>
							<div class="saSidenavContainer">
								<div class="saSidenavItem saMenuDropdownsOuter">
									<div class="saSidenavItemWrapper">
										<label class="saInputTextWrapper saLabeled">
											<span class="saLabeledLabel">User</span>
											<span class="saFirstLetter">J</span>
											<select class="saInputText saDropdown">
												<option value="0" selected="true">Jonathan</option>
												<option value="1">Kevin</option>
											</select>
											<div class="saTrailingIconsWrapper">
												<i class="saIcon far fa-angle-down"></i>
											</div>
										</label>
									</div>
								</div>
								<div class="saToggleGroup" role="tablist" aria-label="Toggle menu/favorites">
									<button class="saDynamicTooltipJs" type="button" id="tabbutton1" role="tab"
										aria-selected="true">
										<i class="saIcon far fa-bars" aria-hidden="true"></i>
										<span class="saToggleText">Menu</span>
									</button>
									<button class="saDynamicTooltipJs" type="button" id="tabbutton2" role="tab">
										<i class="saIcon far fa-star" aria-hidden="true"></i>
										<span class="saToggleText">Favorites</span>
									</button>
								</div>
							</div>
							<div class="saSidenavLists">
								<ul class="saSidenavItemList">
									<li>
										<a class="saSidenavItemWrapper" tabindex="0">
											<div class="saSidenavItem">
												<i class="far fa-crow saIcon"></i>
												<span class="saSidenavItemText">Crow</span>
											</div>
										</a>
									</li>
									<li>
										<a class="saSidenavItemWrapper" tabindex="0">
											<div class="saSidenavItem">
												<i class="far fa-arrow-turn-down-left saIcon"></i>
												<span class="saSidenavItemText">Egg</span>
											</div>
										</a>
									</li>
									<li>
										<a class="saSidenavItemWrapper" tabindex="0">
											<div class="saSidenavItem">
												<i class="far fa-feather saIcon"></i>
												<span class="saSidenavItemText">Flying lessons</span>
											</div>
										</a>
									</li>
									<li>
										<a class="saSidenavItemWrapper" tabindex="0">
											<div class="saSidenavItem">
												<i class="far fa-ticket-alt saIcon"></i>
												<span class="saSidenavItemText">Aviary tickets</span>
											</div>
										</a>
									</li>
								</ul>
							</div>
						</div>
						<div class="saSidenavSection saSidenavSectionLast">
							<div class="saSidenavContainer">
								<div class="saListItem">
									<button class="saSidenavItemWrapper" type="button" aria-expanded="false">
										<div class="saSidenavItem saAvatarWrapperOuter">
											<div class="saAvatarWrapper saUserInitials" aria-hidden="true">JK</div>
											<span class="saSidenavItemText">Jonathan Kevin</span><i
												class="far fa-angle-down saIcon"></i>
										</div>
									</button>
								</div>
								<div class="saSidenavItem saSidenavItemRow">
									<button class="saSidenavItemWrapper" type="button">
										<div class="saSidenavItem">
											<i class="far fa-gear icon saIcon"></i>
											<span class="saSidenavItemText">Admin</span>
										</div>
									</button>
									<button class="saSidenavItemWrapper" type="button">
										<div class="saSidenavItem">
											<i class="far fa-person-limbs-wide icon saIcon"></i>
											<span class="saSidenavItemText">Database designer</span>
										</div>
									</button>
									<button class="saSidenavItemWrapper" type="button">
										<div class="saSidenavItem">
											<i class="far fa-window-restore icon saIcon"></i>
											<span class="saSidenavItemText">Ny flik</span>
										</div>
									</button>
									<button class="saSidenavItemWrapper" type="button">
										<div class="saSidenavItem">
											<i class="far fa-circle-question icon saIcon"></i>
											<span class="saSidenavItemText">Visa hjälpsida - Allmän hjälpsida</span>
										</div>
									</button>
									<button class="saSidenavItemWrapper saNotificationLinkLargeScreen" type="button">
										<div class="saSidenavItem">
											<div><i class="far fa-bell saIcon"></i></div>
											<span class="saSidenavItemText">Notifieringar</span>
										</div>
										<div class="saNotificationBadge saEmpty" aria-hidden="true">
											<div class="saNotificationBadgeCount">0</div>
										</div>
									</button>
								</div>
							</div>
							<div class="saSidenavFooter">
								<a class="saSoftadminLogo" rel="noopener noreferrer" tabindex="-1" href="#">
									<img loading="lazy" class="saLogo" src="../src/img/softadmin-logo-minimized.svg">
									<img loading="lazy" class="saWordmark" src="../src/img/softadmin-logo-expanded.svg">
								</a>
								<button class="saExpander saDynamicTooltipJs" type="button">
									<i class="fa-angles-left far saIcon"></i>
								</button>
							</div>
						</div>
					</div>
				</nav>
			</form>
		</div>
		<div class="saRightFrameRoot">
			<div class="right standardview">
				<div class="pagecontentframe">
					<form class="interface">
						<div class="saDragOverlayWrapper">
							<div class="saDragOverlay">
								<i class="saIcon fas fa-cloud-arrow-up"></i>
								<div>
									<h2>Drop files here</h2>
									<p>Drop your files here, friend.</p>
								</div>
							</div>
						</div>
						<header id="pageheader" class="saPageHeaderHolder">
							<div class="saPageHeader saDesktopHeader">
								<div class="saHeader">
									<div class="saRowWrapper">
										<div class="saTopRow">
											<nav class="saBreadcrumbs">
												<div class="saBackButtonWrapper">
													<button class="saBackButton" type="button" disabled>
														<i class="fa-arrow-left far saBack saIcon"></i>
													</button>
												</div>
											</nav>
										</div>
										<div class="saBottomRow">
											<div class="saTitle">
												<h1 class="saHeaderText">Test</h1>
												<div class="saMarkFavorite saNoSpinner"><button type="button"><i
															class="fas fa-star saFavoriteIcon saFavoriteAdded icon saIcon"></i></button>
												</div>
												<ul class="saSpecialLinksWrapper"></ul>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="saPageHeader saSmallScreenHeader">
								<div class="saHeader">
									<div class="saHeaderInner">
										<div class="saTopRow">
											<div class="saHeaderWrapper">
												<div class="saTitle">
													<h1 class="saHeaderText">Test</h1>
												</div>
											</div>
											<button class="saNavigator" type="button">
												<div class="saNavBar"><span class="saNavBarStripe"></span><span
														class="saNavBarStripe"></span><span
														class="saNavBarStripe"></span>
												</div>
											</button>
											<button class="saNotificationWrapper" type="button" aria-live="polite">
												<div><i class="far fa-bell saIcon"></i></div>
												<div class="saNotificationBadge saEmpty" aria-hidden="true">
													<div class="saNotificationBadgeCount">0</div>
												</div>
											</button>
										</div>
									</div>
									<nav class="saBottomRow saActionLinkBar" style="display: none;"></nav>
								</div>
							</div>
						</header>
						<div class="maincolinner gradients">
							<main id="MI_M" class="menuitem pagecontentframe">
								<div id="MI_ScrollIndicator" class="scrollindicator"></div>
								<div id="MI_ScrollContent" class="scrollcontent saScrollable">
									<div class="scrollcontent-inner">
										<div class="saChatWrapper">
											<div class="saChat">
												<div class="saChatHeader" id="chatname" style="display: none;">
													<div class="saChatTitle">Chat name</div>
													<div class="saChatHeaderDescription">7 members</div>
												</div>
												<ul class="saChatToolbar" role="toolbar" style="display: none;">
													<li>
														<button type="button" class="saButton saDefaultButtonSecondary">
															<i class="far fa-arrow-turn-down-left saIcon"></i>
															Egg
														</button>
													</li>
													<li>
														<button type="button" class="saButton saDefaultButtonSecondary">
															<i class="far fa-crow saIcon"></i>
															Crow
														</button>
													</li>
													<li>
														<button type="button"
															class="saButton saDefaultButtonSecondary IconButton">
															<i class="far fa-ellipsis-vertical saIcon"></i>
														</button>
													</li>
												</ul>
												<ol class="saMessageGroup" aria-role="log" aria-relevant="additions"
													aria-labelledby="chatname" id="chat-log">
													<li role="separator" class="saChatDay">
														<time datetime="2025-09-02">1 december 2024</time>
													</li>
													<li class="saMessage">
														<div class="saSenderAvatarWrapper">
															<div title="Olle Ekman" class="saSenderAvatar saPrimary">OE
															</div>
															<input type="checkbox" name="EÖ"
																class="saAvatarCheckbox saCheckbox"
																aria-label="Select message">
														</div>
														<article class="saMessageInner">
															<div class="saMessageBody">
																<p>Yes Jessica... Let's first address the egg situation
																	and make sure we have all the details sorted out
																	regarding the bird bill of sale? What our progress?
																</p>
																<ul class="saAttachmentList">
																	<li class="saAttachmentItem">
																		<a href="#" download>
																			<i
																				class="saIcon far fa-file-lines saAttachmentIcon"></i>
																			<div class="saAttachmentContent">
																				<div class="saAttachmentName">
																					the-file.txt
																				</div>
																				<div class="saAttachmentSize">200KB
																				</div>
																			</div>
																			<i
																				class="saIcon far fa-arrow-down-to-bracket saAttachmentDownload"></i>
																		</a>
																	</li>

																	<li class="saAttachmentItem">
																		<a href="#" download>
																			<i
																				class="saIcon far fa-file-pdf saAttachmentIcon"></i>
																			<div class="saAttachmentContent">
																				<div class="saAttachmentName">
																					the-file-name-goes-here-and-it-can-go-long-sometime-you-know
																					.pdf
																				</div>
																				<div class="saAttachmentSize">200KB
																				</div>
																			</div>
																			<i
																				class="saIcon far fa-arrow-down-to-bracket saAttachmentDownload"></i>
																		</a>
																	</li>

																	<li class="saAttachmentItem">
																		<a href="#" download>
																			<img loading="lazy"
																				src="../src/img/panorama.jpg"
																				class="saAttachmentPreview">
																			<div class="saAttachmentContent">
																				<div class="saAttachmentName">
																					the-file-name-goes-here-and-it-can-go-long-sometime-you-know
																					.pdf
																				</div>
																				<div class="saAttachmentSize">200KB
																				</div>
																			</div>
																			<i
																				class="saIcon far fa-arrow-down-to-bracket saAttachmentDownload"></i>
																		</a>
																	</li>

																</ul>
															</div>
															<footer class="saMessageFooter">
																<div class="saSenderName">Olle Ekman</div>
																<time class="saMessageTime"
																	datetime="2026-01-12T12:15:12+02:00"
																	aria-label="Sent at 11:00">11:03</time>
															</footer>
														</article>
													</li>
													<li class="saMessage">
														<div class="saSenderAvatarWrapper">
															<div title="Olivia Rydén" class="saSenderAvatar saPurple">MV
															</div>
															<input type="checkbox" name="EÖ"
																class="saAvatarCheckbox saCheckbox"
																aria-label="select message">
														</div>
														<article class="saMessageInner">
															<div class="saMessageBody">
																<p>Hey flock, let's soar UP to new heights this
																	week! Together, we'll reach heights
																	we've never imagined. Spread your wings and
																	let's make magic happen!
																</p>
																<p>As we gather together, envisioning the vast
																	expanse of the sky above us, let's
																	remember the strength we hold when we unite.
																	Each of us brings a unique set of
																	skills and experiences to the table, and when we
																	combine them, we create a
																	powerful
																	force for success. Just like a flock of birds
																	flying in formation, we move
																	forward
																	with purpose and determination. So let's embrace
																	the challenges that lie ahead,
																	knowing that with our collective effort, there's
																	no limit to what we can
																	achieve.
																	Let's lift each other UP, supporting one another
																	as we strive for greatness.
																	Together, we'll soar to new heights and make
																	this week one to remember
																</p>
															</div>
															<footer class="saMessageFooter">
																<div class="saSenderName">His Excellency Master
																	Maximilian-Alexander
																	Vanderbilt-Smithington III of Astoria-on-Thames
																</div>
																<time class="saMessageTime"
																	datetime="2024-12-01T16:39:12+02:00">2024-12-01
																	12:39</time>
															</footer>
														</article>
													</li>
													<li role="separator" class="saChatDay">
														<time datetime="2024-12-02">
															2 december 2024
														</time>
													</li>
													<li class="saMessage">
														<div class="saSenderAvatarWrapper">
															<div title="Olivia Rydén" class="saSenderAvatar saPurple">EÖ
															</div>
															<input type="checkbox" name="EÖ"
																class="saAvatarCheckbox saCheckbox"
																aria-label="select message">
														</div>
														<article class="saMessageInner">
															<div class="saMessageBody">
																<p>Calling all early birds! It's time to rise UP and
																	shine. Let's tweet our successes and fly towards our
																	goals with enthusiasm. Here's to a chirpy day ahead!
																</p>
																<p>
																	<span>As we start our day, let's take a moment to
																		appreciate the beauty of the sunrise and</span>
																	<img class="saMessageImage" loading="lazy"
																		src="../src/img/chat-2.jpg" alt="">
																	<span>the promise of a new beginning. With each task
																		we tackle and each obstacle we overcome, let's
																		remember the strength we possess within
																		ourselves. Like birds greeting the dawn with
																		song, let's approach our work with positivity
																		and determination. And as we navigate through
																		the challenges that come our way, let's support
																		each other with kindness and encouragement.
																		Together, we'll make today a day to remember,
																		filled with accomplishments and moments of joy.
																		So let's spread our wings and soar towards
																		success, knowing that the sky's the limit for
																		our team!</span>
																</p>
															</div>
															<footer class="saMessageFooter">
																<div class="saSenderName">Erik Öster</div>
																<time class="saMessageTime"
																	datetime="2024-12-02T16:39:12+02:00">2024-12-02
																	18:39</time>
															</footer>
														</article>
													</li>

													<li role="separator" class="saChatDay">

														<time datetime="2025-09-02">
															Yesterday
														</time>
													</li>
													<li class="saMessage">
														<div class="saSenderAvatarWrapper">
															<div title="Olivia Rydén" class="saSenderAvatar saPink">JM
															</div>
															<input type="checkbox" name="EÖ"
																class="saAvatarCheckbox saCheckbox"
																aria-label="select message">
														</div>
														<article class="saMessageInner">
															<div class="saMessageBody">
																<p>Wings UP <a href="#" class="saMention">Team</a>. As
																	we navigate through our tasks today.
																</p>
															</div>
															<footer class="saMessageFooter">
																<div class="saSenderName">Jessica Mås</div>
																<time class="saMessageTime"
																	datetime="2026-01-12T12:15:12+02:00"
																	aria-label="Sent at 11:00">11:01</time>
															</footer>
														</article>
													</li>
													<li class="saMessage saSender">
														<article class="saMessageInner">
															<div class="saMessageBody">
																<p>today?</p>
															</div>
															<footer class="saMessageFooter">
																<time class="saMessageTime"
																	datetime="2026-01-12T12:15:12+02:00"
																	aria-label="Sent at 11:00">11:01</time>
															</footer>
														</article>
													</li>
													<li class="saMessage">
														<div class="saSenderAvatarWrapper">
															<div title="Olivia Rydén" class="saSenderAvatar saPurple">EÖ
															</div>
															<input type="checkbox" name="EÖ"
																class="saAvatarCheckbox saCheckbox"
																aria-label="select message">
														</div>
														<div class="saMessageInner">
															<div class="saMessageBody">
																<p>With unity and determination, there's no limit to
																	what we
																	can achieve!
																</p>
															</div>
															<footer class="saMessageFooter">
																<div class="saSenderName">Erik Öster</div>
																<time class="saMessageTime"
																	datetime="2026-01-12T12:15:12+02:00"
																	aria-label="Sent at 11:00">08:11</time>
															</footer>
														</div>
													</li>
													<li class="saChatUnreadWrapper">
														<a href="#firstunreadmessage" class="saChatUnread">2 unread
															messages<i class="fa-caret-down saIcon fas"></i><i
																class="fa-caret-up saIcon fas"></i></a>
													</li>
													<li role="separator" class="saChatDay">
														<time datetime="2025-09-02">
															Today
														</time>
													</li>
													<li class="saMessage saUnread" id="firstunreadmessage">
														<div class="saSenderAvatarWrapper">
															<img loading="lazy" title="Molker Birdley"
																class="saSenderAvatar" src="../src/img/avatar2.png">
															<input type="checkbox" name="EÖ"
																class="saAvatarCheckbox saCheckbox"
																aria-label="Select message">
														</div>
														<article class="saMessageInner">
															<div class="saMessageBody">
																<p>
																	BTW <a href="#" class="saMention">Peter</a> and <a
																		href="#" class="saMention">Olle</a>,<br>
																	Just wanted to check in and see if there are any
																	updates on the egg situation. Let's make sure we're
																	on track to resolve it efficiently. Also, it's time
																	we discuss the bird bill of sale. I'll be available
																	for a meeting later today to go over the details.
																	Looking forward to hearing from everyone!
																</p>
																<p>
																	I love.
																</p>
															</div>
															<footer class="saMessageFooter">
																<div class="saSenderName">Molker Birdley</div>
																<time class="saMessageTime"
																	datetime="2026-01-12T12:15:12+02:00"
																	aria-label="Sent at 05:40">06:51</time>
															</footer>
														</article>
													</li>
													<li class="saMessage saUnread">
														<div class="saSenderAvatarWrapper">
															<img loading="lazy" title="Stefan Stefan"
																class="saSenderAvatar"
																src="https://untitledui.com/images/avatars/loki-bright">
															<input type="checkbox" name="SS"
																class="saAvatarCheckbox saCheckbox"
																aria-label="Select message">
														</div>
														<article class="saMessageInner">
															<div class="saMessageBody">
																<p>
																	Let's make sure we're on track to resolve it
																	efficiently. Also, it's time we discuss the bird
																	bill of sale. I'll be available for a meeting later
																	today to go over the details. Looking forward to
																	hearing from everyone!
																</p>
															</div>
															<footer class="saMessageFooter">
																<div class="saSenderName">Stefan Stefan</div>
																<time class="saMessageTime"
																	datetime="2026-01-12T12:15:12+02:00"
																	aria-label="Sent at 07:21">07:21</time>
															</footer>
														</article>
													</li>
												</ol>
												<div class="saChatComposer" id="composer">
													<textarea name="message" placeholder="Write your message..." id="message"></textarea>
													<div class="saChatToolbar" role="toolbar">
														<label class="saButtonUpload" tabindex="0">
															<input type="file" type="button" class="saButtonToolbar"
																aria-label="Attatch" id="file-input" multiple>
															<i class="fa-paperclip saIcon far"></i>
														</label>
														<button type="submit" class="saButtonSend" disabled
															aria-label="Send message" title="Send message">
															<i class="fa-arrow-up saIcon far"></i>
														</button>
													</div>
												</div>
												<ul class="saAttachmentList" id="attachmentList">
													<li class="saAttachmentItem">
														<a href="#" download>
															<i class="saIcon far fa-file-lines saAttachmentIcon"></i>
															<div class="saAttachmentContent">
																<div class="saAttachmentName">
																	the-file.txt
																</div>
																<div class="saAttachmentSize">200 KB</div>
															</div>
														</a>
														<button type="button" aria-label="Remove file-name.jpg"
															class="saAttachmentRemove" disabled>
															<div class="saAttachmentLoader"></div>
															<i class="saIcon far fa-trash-alt"></i>
														</button>
													</li>
													<li class="saAttachmentItem">
														<a href="#" download>
															<i class="saIcon far fa-file-pdf saAttachmentIcon"></i>
															<div class="saAttachmentContent">
																<div class="saAttachmentName">
																	the-file-name-goes-here-and-it-can-go-long-sometime-you-know.pdf
																</div>
																<div class="saAttachmentSize">200 KB</div>
															</div>
														</a>
														<button type="button" aria-label="Remove file-name.jpg"
															class="saAttachmentRemove" disabled>
															<div class="saAttachmentLoader"></div>
															<i class="saIcon far fa-trash-alt"></i>
														</button>
													</li>
													<li class="saAttachmentItem">
														<a href="#" download>
															<img loading="lazy" class="saAttachmentPreview"
																src="../src/img/chat-3.jpg">
															<div class="saAttachmentContent">
																<div class="saAttachmentName">
																	image-name-isHere--.png
																</div>
																<div class="saAttachmentSize">21 KB</div>
															</div>
														</a>
														<button type="button" aria-label="Remove file-name.jpg"
															class="saAttachmentRemove" disabled>
															<div class="saAttachmentLoader"></div>
															<i class="saIcon far fa-trash-alt"></i>
														</button>
													</li>
												</ul>
											</div>
										</div>
									</div>
								</div>
							</main>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</body>
<script>
	const ChatApp = (() => {
		// State variables
		let msgId = 1;
		let lastMessageTime = null;
		let lastMessageFrom = null;
		let lastMessageDay = null;
		let attachments = [];
		let holdTimer;
		let isChildVisible = false;

		// DOM elements
		const elements = {
			$log: $('.saMessageGroup'),
			$composer: $('.saChatComposer'),
			$input: $('#message'),
			$sendButton: $('.saButtonSend'),
			$attachInput: $('#file-input'),
			$attachmentList: $('#attachmentList'),
			$rootBody: $('.saRootBody'),
			$toolbar: null
		};

		// Utility functions
		const utils = {
			isNearBottom: () => {
				if (!elements.$log.length) return false;
				const { scrollHeight, scrollTop } = elements.$log[0];
				const clientHeight = elements.$log.innerHeight();
				return scrollHeight - scrollTop - clientHeight < 48;
			},

			scrollToBottom: (animate = true) => {
				if (!elements.$log.length) return;
				const scrollHeight = elements.$log[0].scrollHeight;
				if (animate) {
					elements.$log.animate({ scrollTop: scrollHeight }, 300);
				} else {
					elements.$log.scrollTop(scrollHeight);
				}
			},

			getDateLabel: (date) => {
				const today = new Date('2025-09-09T20:35:00+02:00');
				const yesterday = new Date(today);
				yesterday.setDate(yesterday.getDate() - 1);

				if (date.toDateString() === today.toDateString()) return 'Today';
				if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
				return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
			},

			formatFileSize: (bytes) => {
				if (bytes < 1024) return `${bytes} B`;
				if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
				return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
			},

			getFileIcon: (file) => {
				const type = file.type || '';
				if (type.startsWith('image/')) return 'fa-image';
				if (type === 'application/pdf') return 'fa-file-pdf';
				if (type.startsWith('text/')) return 'fa-file-alt';
				if (type.startsWith('video/')) return 'fa-file-video';
				if (type.startsWith('audio/')) return 'fa-file-audio';
				return 'fa-file';
			},

			announceToScreenReader: (message) => {
				const $announcement = $('<div>', {
					role: 'status',
					'aria-live': 'polite',
					class: 'saScreenReaderOnly'
				}).text(message);
				$('body').append($announcement);
				setTimeout(() => $announcement.remove(), 2000);
			}
		};

		// Message handling
		const messageHandler = {
			insertDateSeparator: (now) => {
				const currentDay = now.toDateString();
				if (lastMessageDay !== currentDay) {
					const label = utils.getDateLabel(now);
					const $separator = $('<li>', {
						role: 'separator',
						class: 'saChatDay',
						'aria-label': `Messages from ${label}`
					}).append(
						$('<time>', {
							datetime: now.toISOString().split('T')[0]
						}).text(label)
					);
					elements.$log.append($separator);
					lastMessageDay = currentDay;
				}
			},

			createMessageStructure: ({ from, fullName, initials, text, sender = false, files = [], timestamp }) => {
				const now = timestamp ? new Date(timestamp) : new Date();
				const currentMinute = Math.floor(now.getTime() / 60000);
				const lastMinute = lastMessageTime ? Math.floor(lastMessageTime.getTime() / 60000) : null;
				const messageId = `message-${msgId++}`;

				messageHandler.insertDateSeparator(now);

				let $targetLi, $article, $messageBody;

				if (lastMessageFrom === from && currentMinute === lastMinute) {
					$targetLi = elements.$log.children('li').last();
					if ($targetLi.hasClass('saMessage')) {
						$article = $targetLi.find('.saMessageInner');
						$messageBody = $article.find('.saMessageBody');
					}
				}

				if (!$targetLi || !$article?.length || !$messageBody?.length) {
					const messageClasses = sender ? 'saMessage saSender' : 'saMessage';
					$targetLi = $('<li>', {
						class: messageClasses,
						'data-id': msgId - 1,
						'data-read': 'false',
						'data-from': from,
						id: messageId
					});

					if (!sender) {
						const $avatarWrapper = $('<div>', { class: 'saSenderAvatarWrapper' });
						const $avatar = $('<div>', {
							class: 'saSenderAvatar saPrimary',
							title: fullName
						}).text(initials);
						$avatarWrapper.append($avatar);
						$targetLi.append($avatarWrapper);
					}

					$article = $('<article>', { class: 'saMessageInner' });
					$messageBody = $('<div>', { class: 'saMessageBody' });
					const $footer = $('<footer>', { class: 'saMessageFooter' });

					if (!sender) {
						$footer.append($('<div>', { class: 'saSenderName' }).text(from));
					}

					$footer.append(
						$('<time>', {
							class: 'saMessageTime',
							datetime: now.toISOString()
						}).text(now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }))
					);

					$article.append($messageBody, $footer);
					$targetLi.append($article);
					elements.$log.append($targetLi);
				}

				if (text?.trim()) {
					$messageBody.append($('<p>').text(text));
				}

				if (files.length > 0) {
					let $fileList = $messageBody.find('#attachmentList');
					if (!$fileList.length) {
						$fileList = $('<ul>', { class: 'saAttachmentList' });
						$messageBody.append($fileList);
					}

					files.forEach(file => {
						const isImage = file.type.startsWith('image/');
						const fileUrl = URL.createObjectURL(file);
						const $li = $('<li>', { class: 'saAttachmentItem' });
						const $link = $('<a>', { href: fileUrl, download: file.name });
						const $icon = $('<i>', { class: `saIcon far ${utils.getFileIcon(file)} saAttachmentIcon` });
						const $content = $('<div>', { class: 'saAttachmentContent' });
						const $name = $('<div>', { class: 'saAttachmentName' }).text(file.name);
						const $size = $('<div>', { class: 'saAttachmentSize' }).text(utils.formatFileSize(file.size));
						const $downloadIcon = $('<i>', { class: 'saIcon far fa-arrow-down-to-bracket saAttachmentDownload' });

						$content.append($name, $size);

						if (isImage) {
							const $preview = $('<img>', { src: fileUrl, class: 'saAttachmentPreview', loading: 'lazy' });
							$link.append($preview, $content, $downloadIcon);
						} else {
							$link.append($icon, $content, $downloadIcon);
						}

						$li.append($link);
						$fileList.append($li);

						setTimeout(() => URL.revokeObjectURL(fileUrl), 60000);
					});
				}

				lastMessageTime = now;
				lastMessageFrom = from;

				if (!timestamp) {
					utils.scrollToBottom(true);
					messageHandler.markAsRead($targetLi);
				} else if (utils.isNearBottom()) {
					utils.scrollToBottom(true);
					messageHandler.markAsRead($targetLi);
				}

				return $targetLi;
			},

			markAsRead: ($msg) => {
				if ($msg.attr('data-read') === 'false') {
					$msg.attr('data-read', 'true').removeClass('saUnread');
				}
			},

			markVisibleAsRead: () => {
				if (!elements.$log.length) return;
				const containerRect = elements.$log[0].getBoundingClientRect();
				elements.$log.find('li[data-read="false"]').each(function () {
					const rect = this.getBoundingClientRect();
					if (rect.top >= containerRect.top && rect.bottom <= containerRect.bottom) {
						messageHandler.markAsRead($(this));
					}
				});
			}
		};

		// Attachment handling
		const attachmentHandler = {
			addAttachment: (file) => {
				const fileId = `attachment-${Date.now()}-${Math.random()}`;
				const $li = $('<li>', { class: 'saAttachmentItem' });
				const isImage = file.type.startsWith('image/');
				const fileUrl = URL.createObjectURL(file);

				const $link = $('<a>', {
					href: fileUrl,
					download: file.name,
					'aria-describedby': `${fileId}-desc`,
					'aria-label': `Download ${file.name}, ${utils.formatFileSize(file.size)}`
				});

				const $icon = $('<i>', { class: `saAttachmentIcon saIcon far ${utils.getFileIcon(file)}`, 'aria-hidden': 'true' });
				const $preview = isImage ? $('<img>', { src: fileUrl, class: 'saAttachmentPreview', 'aria-hidden': 'true' }) : null;
				const $content = $('<div class="saAttachmentContent">').append(
					$('<div>').addClass('saAttachmentName').text(file.name),
					$('<div>').addClass('saAttachmentSize').text(utils.formatFileSize(file.size))
				);

				const $removeBtn = $('<button>', {
					type: 'button',
					'aria-label': `Remove file ${file.name}`,
					class: 'saAttachmentRemove',
					disabled: true
				}).append(
					$('<i>', { class: 'saIcon far fa-trash-alt', 'aria-hidden': 'true' }),
					$('<div>', { class: 'saAttachmentLoader', 'aria-hidden': 'true' })
				);

				if ($preview) $link.append($preview, $content);
				else $link.append($icon, $content);

				$li.append($link, $removeBtn);
				elements.$attachmentList.append($li);
				attachments.push(file);
				attachmentHandler.updateSendButtonState();
				utils.announceToScreenReader(`File ${file.name} attached`);

				// Simulate file upload completion
				setTimeout(() => {
					$removeBtn.removeAttr('disabled');
					utils.announceToScreenReader(`File ${file.name} upload completed`);
				}, 2000); // Simulated 2-second upload delay

				$removeBtn.on('click', () => {
					if ($preview) URL.revokeObjectURL($preview.attr('src'));
					URL.revokeObjectURL($link.attr('href'));
					$li.remove();
					attachments = attachments.filter(f => f !== file);
					attachmentHandler.updateSendButtonState();
					utils.announceToScreenReader(`File ${file.name} removed`);
				});
			},

			updateSendButtonState: () => {
				const hasContent = elements.$input.val().trim() !== '' || attachments.length > 0;
				elements.$sendButton.prop('disabled', !hasContent)
					.attr('aria-label', hasContent ? 'Send message' : 'Send message (disabled - enter text or attach files)');
			}
		};

		// Event handlers
		const eventHandlers = {
			handleDragOver: (e) => {
				e.preventDefault();
				e.stopPropagation();
				elements.$rootBody.addClass('saDragOver');
				elements.$attachmentList.attr('aria-label', 'Attached files (drop files here to attach)');
			},

			handleDragLeave: (e) => {
				e.preventDefault();
				e.stopPropagation();
				if (e.target === elements.$rootBody[0]) {
					elements.$rootBody.removeClass('saDragOver');
					elements.$attachmentList.attr('aria-label', 'Attached files');
				}
			},

			handleDrop: (e) => {
				e.preventDefault();
				e.stopPropagation();
				elements.$rootBody.removeClass('saDragOver');
				elements.$attachmentList.attr('aria-label', 'Attached files');
				const files = Array.from(e.originalEvent.dataTransfer.files);
				files.forEach(attachmentHandler.addAttachment);
				utils.announceToScreenReader(`${files.length} ${files.length === 1 ? 'file' : 'files'} attached`);
			},

			handleLongPress: function () {
				$('.saMessage').removeClass('saSelected');
				$(this).toggleClass('saSelected');
			},

			setupToolbar: () => {
				elements.$toolbar = $(`
                <ul class="saMessageToolbar" role="toolbar" id="toolbar" style="display: none;">
                    <li><button type="button" class="saButton saIconButton" aria-label="Reply" title="Reply to message"><i class="saIcon far fa-arrow-turn-down-left"></i></button></li>
                    <li><button type="button" class="saButton saIconButton" aria-label="Edit" title="Edit message"><i class="saIcon far fa-feather"></i></button></li>
                    <li><button type="button" class="saButton saIconButton" aria-label="More options" title="More options"><i class="saIcon far fa-ellipsis-vertical"></i></button></li>
                </ul>
            `);
				$('body').append(elements.$toolbar);

				elements.$toolbar.find('button').on('click', (e) => {
					e.preventDefault();
					const buttonText = $(e.currentTarget).attr('aria-label');
					const associatedText = elements.$toolbar.data('associatedP')?.text() || '';
					utils.announceToScreenReader(`${buttonText} clicked for: ${associatedText.substring(0, 50)}...`);
				});
			},

			handleScroll: () => {
				messageHandler.markVisibleAsRead();
				$(".saChatDay").each(function (index) {
					const firstSticky = $(this);
					const pill = firstSticky.find('time');
					const secondSticky = $(".saChatDay").eq(index + 1);

					if (secondSticky.length) {
						const distance = secondSticky.offset().top - firstSticky.offset().top;
						if (distance <= 100) {
							const scale = Math.max(0, distance / 100).toFixed(2);
							pill.css("transform", `scale(${scale <= 0.1 ? 0 : scale})`);
						} else {
							pill.css("transform", "scale(1)");
						}

						if (distance <= 50) {
							const opacity = Math.max(0, distance / 50).toFixed(2);
							pill.css("opacity", opacity <= 0.1 ? 0 : opacity);
						} else {
							pill.css("opacity", "1");
						}
					}

					const chatDayWrapper = $(this);
					const distanceFromTop = chatDayWrapper.offset().top - elements.$log.offset().top;
					let widthPercentage = Math.max(0, Math.min(100, (distanceFromTop / 100) * 100));
					if (widthPercentage < 10) widthPercentage = 0;
					chatDayWrapper.find('.saLine').css('width', `calc(${widthPercentage}% - 32px)`);
				});
			},

			handleUnreadMessages: () => {
				const containerTop = elements.$log.offset()?.top || 0;
				const containerBottom = containerTop + elements.$log.height();

				$(".saMessage.saUnread").each(function () {
					const targetTop = $(this).offset().top;
					if (targetTop >= containerTop && targetTop <= containerBottom - 40) {
						$(this).addClass('saRead');
						setTimeout(() => {
							$(this).removeClass('saUnread saRead');
							if ($(".saChat .saUnread").length === 0) {
								$(".saChatUnreadWrapper").animate({ opacity: 0, height: 0 }, 400, () => {
									$(".saChatUnreadWrapper").remove();
								});
							}
						}, 1000);
					}
				});
			},

			handleFirstUnreadVisibility: () => {
				const childDiv = $('#firstunreadmessage');
				if (childDiv.length) {
					const containerTop = elements.$log.offset()?.top || 0;
					const containerBottom = containerTop + elements.$log.height();
					const childTop = childDiv.offset().top;
					const childBottom = childTop + childDiv.height();
					const isVisible = childBottom >= containerTop && childTop <= containerBottom;

					if (isVisible && !isChildVisible) {
						$('.saChatUnreadWrapper').removeClass('saAbove');
						isChildVisible = true;
					} else if (!isVisible && isChildVisible) {
						$('.saChatUnreadWrapper').addClass('saAbove');
						isChildVisible = false;
					}
				}
			},

			handleSendButtonClick: (e) => {
				e.preventDefault();
				if (!elements.$sendButton.prop('disabled')) {
					elements.$composer.trigger('submit');
				}
			}
		};

		// Initialize
		const init = () => {
			// Validate required elements
			for (const [selector, $element] of Object.entries(elements)) {
				if (selector !== '$toolbar' && (!$element || !$element.length)) {
					console.error(`Required element ${selector} not found`);
					return;
				}
			}

			// Setup event listeners
			elements.$rootBody
				.on('dragover dragenter', eventHandlers.handleDragOver)
				.on('dragleave', eventHandlers.handleDragLeave)
				.on('drop', eventHandlers.handleDrop);

			elements.$log
				.on('scroll', eventHandlers.handleScroll)
				.on('scroll', eventHandlers.handleUnreadMessages)
				.on('scroll', eventHandlers.handleFirstUnreadVisibility);

			elements.$input
				.on('input', attachmentHandler.updateSendButtonState)
				.on('keydown', (e) => {
					if (e.key === 'Enter' && !e.shiftKey) {
						e.preventDefault();
						if (!elements.$input.prop('disabled')) elements.$composer.trigger('submit');
					}
				});

			elements.$attachInput.on('change', () => {
				Array.from(elements.$attachInput[0].files || []).forEach(attachmentHandler.addAttachment);
				elements.$attachInput.val('');
			});

			elements.$composer.on('submit', (e) => {
				e.preventDefault();
				const text = elements.$input.val().trim();
				if (!text && attachments.length === 0) return;

				messageHandler.createMessageStructure({
					from: 'You',
					fullName: 'Me',
					initials: 'ME',
					text,
					files: [...attachments],
					sender: true
				});

				elements.$input.val('').focus();
				elements.$attachmentList.empty();
				attachments = [];
				attachmentHandler.updateSendButtonState();
				utils.announceToScreenReader('Message sent');
			});

			elements.$sendButton.on('click', eventHandlers.handleSendButtonClick);

			$(document)
				.on('touchstart', '.saMessage', function () {
					holdTimer = setTimeout(eventHandlers.handleLongPress.bind(this), 800);
				})
				.on('touchend', '.saMessage', () => clearTimeout(holdTimer))
				.on('click touchstart', (event) => {
					if (!$(event.target).closest('.saMessage.saSelected').length) {
						$('.saMessage').removeClass('saSelected');
					}
				})
				.on('mouseenter focus', 'p', function () {
					const $p = $(this);
					const offset = $p.offset();
					elements.$toolbar?.css({
						top: offset.top,
						left: offset.left + $p.outerWidth() - elements.$toolbar.outerWidth(),
						display: 'flex'
					}).data('associatedP', $p);
				})
				.on('mouseleave blur', 'p', function () {
					if (elements.$toolbar && !elements.$toolbar.is(':hover')) elements.$toolbar.hide();
				});

			elements.$composer.find('button[aria-label^="Insert emoji"]').on('click', () => {
				utils.announceToScreenReader('Emoji picker would open here');
			});

			$(window).on('scroll', () => elements.$toolbar?.hide());
			if (elements.$toolbar) elements.$toolbar.on('mouseleave', () => elements.$toolbar.hide());

			// Setup toolbar
			eventHandlers.setupToolbar();

			utils.scrollToBottom(false);
			messageHandler.markVisibleAsRead();
			attachmentHandler.updateSendButtonState();
			elements.$input.focus();
		};

		// Public API
		return { init };
	})();

	jQuery(document).ready(() => ChatApp.init());
</script>

</html>